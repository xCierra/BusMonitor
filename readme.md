# 车票回流监控脚本

## 项目简介
这是一个用于自动监控特定城际公交线路余票情况的Python脚本。当您心仪的班次无票时，它可以持续监控，并在发现“回流票”（即票数从0变为有票）时，通过**QQ邮件**立即通知您，帮助您抓住他人退票的机会。

## ✨ 核心功能
- **全自动查询**：自动获取指定日期的所有班次信息（时间、余票、票价等）。
- **智能筛选**：清晰列出**有票**和**无票**班次，提供美观的彩色表格供选择。
- **回流票监控**：对选定的无票班次，进行定时、持续的余票监控。
- **邮件通知**：发现回流票时，自动发送**详细邮件通知**到指定QQ邮箱。

## 🛠️ 核心配置与参数获取
脚本运行依赖于从目标网站获取的动态参数。以下是关键的配置部分及其获取方法。

### 1. 配置位置总览
脚本中需要你关注和修改的配置主要有三处，均位于 `bus_monitor.py` 文件中：
1. **邮件配置 (`EMAIL_CONFIG`)**：在文件开头的 `import` 语句之后。
2. **请求头 (`headers`)**：在 `RefundTicketMonitor` 类的 `__init__` 方法中。
3. **请求参数 (`base_params`)**：在 `RefundTicketMonitor` 类的 `__init__` 方法中。

### 2. 如何获取动态参数 (关键步骤)
`authorization` 令牌和 `_JsonText` 等参数会过期或变化，需要手动从网站获取。请按以下步骤操作：

**步骤一：模拟一次手动查询**
1.  在 **电脑浏览器**（推荐 Chrome 或 Edge）中，访问你通常查询该线路车票的 **官方网站或小程序网页版**。
2.  按 `F12` 打开“开发者工具”，切换到 **“网络” (Network)** 标签。
3.  在网站上，**手动执行一次完整的车票查询**：选择“xxx”作为起点，“xxx”作为终点，选择一个日期，点击查询。

**步骤二：捕获网络请求并提取参数**
1.  在开发者工具的“网络”请求列表中，寻找一个包含 `GisLineClassDayNewQuery` 关键词的请求（通常是 `GET` 类型）。
2.  点击该请求，在右侧面板中查看其“标头” (`Headers`) 和“载荷” (`Payload`)。
3.  **复制请求头 (`authorization`)**
    *   在“请求标头”部分，找到 `authorization` 字段。
    *   将其**完整的值**（一串以 `eyJ...` 开头的长字符）复制出来。
    *   **修改位置**：粘贴到代码 `RefundTicketMonitor` 类 `__init__` 方法中，替换 `headers` 字典里旧的 `authorization` 值。
    ```python
    self.headers = {
        "authorization": "这里粘贴你刚复制的全新长令牌", # <--- 修改这里
        "user-agent": "Mozilla/5.0 ...",
        # ... 其他头
    }
    ```
4.  **复制查询参数 (`_JsonText` 等)**
    *   切换到“载荷” (`Payload`) 标签，查看 `Query String Parameters`。
    *   你需要关注并确保与代码中 `base_params` 及 `update_params` 方法里生成的参数一致，特别是 `_JsonText`。你可以直接复制 `_JsonText` 的完整值。
    *   **修改位置**：此参数主要在 `update_params` 方法中通过 `json.dumps` 生成。如果你复制的 `_JsonText` 结构与原代码不同，你可能需要调整 `_JsonText` 字典的内容，确保其包含必要的定位和搜索信息。

### 3. QQ邮件通知配置 (`EMAIL_CONFIG`)
此配置位于脚本文件**开头的 import 语句之后**，用于设置邮件提醒。

```python
EMAIL_CONFIG = {
    'smtp_server': 'smtp.qq.com',       # QQ邮箱SMTP服务器，固定
    'smtp_port': 465,                    # SSL加密端口，固定
    'sender_email': '你的QQ邮箱@qq.com',  # 【需修改】发件人QQ邮箱
    'sender_name': '车票监控助手',        # 发件人显示名称，可自定义
    'authorization_code': '你的16位授权码', # 【关键】在QQ邮箱设置中生成的授权码，不是密码！
    'receiver_email': '接收通知的邮箱地址'   # 【需修改】接收提醒的邮箱
}
```
**配置要点**：
- **`authorization_code`**：最重要的凭证。请在QQ邮箱网页版（设置 → 账户 → POP3/IMAP服务）中开启服务后生成。
- **`sender_email` 与 `receiver_email`**：可以设置为同一个邮箱。

## ⚙️ 核心函数说明

### 1. 主监控函数：`monitor_refund_ticket(...)`
这是脚本的核心，负责持续检查余票变化。

**工作流程**：
1.  **初始化**：打印开始信息。
2.  **循环检查**：定时获取最新数据，对比票数变化。
3.  **判断与触发**：
    - **发现回流票**（票数从0变为≥阈值）时：控制台高亮提醒、调用邮件函数、播放提示音。
    - 票数其他变化时，仅在控制台输出信息。
4.  **状态管理**：可自动停止或手动中断。

**关键参数**：
- `target_class_info`：班次详情字典。
- `check_interval`：检查间隔（秒），**建议不小于30秒**。
- `alert_threshold`：触发提醒的票数阈值（默认1张）。

### 2. 邮件发送函数：`send_email_notification(subject, content)`
被主函数调用，独立发送邮件。

**工作流程**：
1.  **构建邮件**：使用 `EMAIL_CONFIG` 配置。
2.  **安全连接**：通过SSL连接QQ邮箱SMTP服务器 (`smtp.qq.com:465`)。
3.  **登录发送**：使用邮箱和授权码登录后发送。
4.  **错误处理**：捕获并提示常见错误（如认证失败）。

## 🚀 快速开始

### 1. 环境准备
确保系统已安装 **Python 3.7+**。

### 2. 安装依赖
```bash
pip install requests urllib3
```

### 3. 获取并更新配置（最重要！）
1.  **获取API令牌与参数**：严格按照上文 **`核心配置与参数获取`** 部分的步骤，从网站获取最新的 `authorization` 令牌和查询参数，并更新到代码的对应位置。
2.  **配置邮件通知**：按照上文说明，填写 `EMAIL_CONFIG` 字典中的所有字段，特别是正确的QQ邮箱授权码。

### 4. 运行脚本
1.  在终端中运行脚本：
    ```bash
    python bus_monitor.py
    ```
2.  根据交互提示输入监控日期（如 `2025-12-01`）。
3.  脚本将列出所有班次，请从 **无票班次列表** 中选择序号，开始监控。

## 📧 邮件通知效果示例
收到邮件内容大致如下：
```
【回流票提醒】2025-12-01 08:30 班次

发现车票回流！
日期：2025-12-01
班次：08:30 -> 10:05
当前余票：2 张
票价：¥45
运行时间：95分钟
速去抢票！
```

## 🔍 常见问题 (FAQ)

**Q：运行后提示“登陆已过期”或“未找到任何班次信息”？**
A：这几乎总是因为 `authorization` 令牌失效。请严格按照 **`核心配置与参数获取`** 部分的步骤，重新获取并替换代码中的令牌。同时检查请求参数（如 `_JsonText`）是否也已更新。

**Q：收不到邮件通知？**
A：请按顺序检查：
1.  `EMAIL_CONFIG` 配置是否正确，特别是16位授权码。
2.  QQ邮箱SMTP服务是否已开启。
3.  服务器防火墙是否放行465端口。

**Q：如何监控另一条线路？**
A：需要修改代码中的请求参数。主要更新 `RefundTicketMonitor` 类 `__init__` 方法里的 `base_params` 字典，包括起终点的名称、GIS坐标、城市代码等。之后，同样需要按照 **`核心配置与参数获取`** 步骤，用新线路手动查询一次，以获取对应的新令牌和参数。

## 📄 免责声明
本项目仅供学习和技术交流使用。请务必合理设置查询频率，尊重目标网站的服务压力。车票信息请以官方平台为准，开发者不对因使用此工具而导致的任何问题负责。

---
**配置是关键！** 请确保在运行前，已完成 **`获取并更新配置`** 的所有步骤。祝您购票顺利！